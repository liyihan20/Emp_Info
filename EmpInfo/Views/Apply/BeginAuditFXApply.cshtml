@using EmpInfo.Models;
@{
    BeginAuditModel bam = ViewData["bam"] as BeginAuditModel;
    FXAuditOtherInfoModel other = bam.otherInfo as FXAuditOtherInfoModel;
}
@section CSS{
    <link rel="stylesheet" href="@Url.Content("~/Content/webupload/webuploader.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Content/bootstrap-table/bootstrap-table.min.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Content/bootstrap-datetimepicker.min.css")" />
    }

@section Scripts {
    <script src="@Url.Content("~/Scripts/webuploader.min.js")"></script>
    <script src="@Url.Content("~/Scripts/myUploaderPro.js?v=2")"></script>
    <script src="@Url.Content("~/Scripts/bootstrap-datetimepicker.min.js")"></script>
    <script src="@Url.Content("~/Scripts/bootstrap-datetimepicker.zh-CN.js")"></script>
    <script src="@Url.Content("~/Scripts/myInputDialog.js")"></script>
    <script>

        $(function () {
            $("#applyContent").load("CheckApply", { sysNo: "@bam.sysNum" }, function () {
                $($("#applyContent .panel-heading")[0]).html("<i class='fa fa-list'></i> @bam.billTypeName 详情");
                $("#waiting").remove();
                $(".auditContent").css("visibility", "visible");                
            });

            $(".datePicker").datetimepicker({
                language: 'zh-CN',
                format: "yyyy-mm-dd",
                autoclose: true,
                startView: 2,
                minView: 2,
                endDate:"@DateTime.Now.ToString("yyyy-MM-dd")"
            });

            if ($("#myUploader1").length > 0) {
                console.log("1");
                $("#myUploader1").myUploader({
                    sysNum: "@bam.sysNum",
                    fileNumLimit: 5,
                    accept: {
                        title: '*',
                        extensions: '*',
                        mimeTypes: '*'
                    }
                });
            }

            $("#getCodeInfoBt").on("click", function () {
                var code = $.trim($("#outCode").val().replace("_", "-"));
                $("#outCode").val(code);

                if (code.length != 20) {
                    toastr.error("请输入正确的预约码后再查询");
                    return;
                }

                $("#getCodeInfoBt").button("loading");

                $.post("../Item/GetOuterPeopleInfo", { code: code }, function (data) {
                    $("#getCodeInfoBt").button("reset");
                    if (!data.suc) {
                        toastr.error(data.msg);
                        return;
                    }
                    toastr.success(data.msg);
                    var info = JSON.parse(data.extra);
                    $("#outerName").val(info.FName);
                    $("#outerPhone").val(info.FPhone);

                    $("#outerId").val(info.FCodeId);
                    $("#outerCar").val(info.FCarNo);
                    $("#outerVisitNo").val(info.FNO);

                    if (info.items.length > 0) {
                        $("#itemDiv").show();
                    } else {
                        $("#itemDiv").hide();
                    }

                    $("#tb3").bootstrapTable("load", info.items);
                });

            });

            $("#outCode").on("keydown", function () {
                $("#outerName").val("");
                $("#outerPhone").val("");

                $("#outerId").val("");
                $("#outerCar").val("");
                $("#outerVisitNo").val("");

                $("#tb3").bootstrapTable("load", []);
            });

        })

        function audit(isPass) {
            if(isPass){
                if ("@bam.stepName".indexOf("上传") >= 0) {
                    if ($("#myUploader1").find(".list-group li").length < 1) {
                        toastr.error("请先上传放行物品图片");
                        return;
                    }
                }
            }else{
                if($.trim($("#opinion").val()) == ""){
                    toastr.error("拒绝时必须填写审批意见。")
                    return;
                }
            }

            if ($("#tb3").length > 0 && $("#items").length>0) {
                $("#items").val(utils.StringifyAndParseCharacter($("#tb3").bootstrapTable('getData')));
            }

            openConfirmDialog("确认要" + (isPass ? "同意" : "拒绝") + "此申请吗？", function () {
                $("#isPass").val(isPass);

                $.ajax({
                    type: 'post',
                    url: 'HandleApply',
                    data: $("#auditForm").serialize(),
                    cache: false,
                    dataType: 'json',
                    success: function (data) {
                        if (data.suc) {
                            toastr.success(data.msg);
                            setTimeout(function () { window.location.href = "@string.Concat("GetMyAuditingList?billType=",bam.billType)"; }, 2000);
                        } else {
                            toastr.error(data.msg);
                        }

                    }
                });

            });
        }

    </script>

    @if (bam.stepName.Contains("预约码")) {
        <script>
            setTimeout(function(){
                $(function(){
                    $.getScript("@Url.Content("~/Content/bootstrap-table/bootstrap-table.js")",function(){
                        $("#tb3").bootstrapTable({
                            striped: true,
                            clickToSelect: true,
                            idField: "entry_id", //用于修改
                            uniqueId: "entry_id", //用于删除
                            columns: [
                                {
                                    radio: true
                                },
                                {
                                    field: "item_name",
                                    title: "物品名称"
                                }, {
                                    field: "item_model",
                                    title: "物品型号"
                                }, {
                                    field: "in_qty",
                                    title: "入厂数量"
                                }, {
                                    field: "out_qty",
                                    title: "出厂数量"
                                }, {
                                    field: "unit_name",
                                    title: "单位"
                                }, {
                                    field: "comment",
                                    title: "备注"
                                }
                            ],
                            onDblClickRow: function (row, $element, field) {
                                $("#editBt2").trigger("click");
                            }
                        });

                        $(function () {
                            $("#editBt2").on("click", function () {
                                var rows = $('#tb3').bootstrapTable('getSelections');
                                if (rows.length == 0) {
                                    toastr.error("请先选择一行后再修改");
                                    return;
                                }
                                var row = rows[0];
                                var updateIndex = row.entry_id;

                                $.inputDialog({
                                    title: "录入出厂数量",
                                    confirmButtonText: "确认修改",
                                    controls: [{ text: "出厂数量", name: "outQty", defaultValue: row.out_qty, placeholder: "请录入实际出厂数量" }],
                                    callback: function (result) {
                                        var v = result.outQty;
                                        if (!utils.testIsInt(v)) {
                                            toastr.error("必须录入整数");
                                            return false;
                                        }
                                        if (parseInt(v) < 0) {
                                            toastr.error("不能录入负数");
                                            return false;
                                        }
                                        if (parseInt(v) > row.in_qty) {
                                            toastr.error("出厂数量不能大于入厂数量");
                                            return false;
                                        }

                                        row.out_qty = v;
                                        $("#tb3").bootstrapTable('updateByUniqueId', { id: updateIndex, row: row });
                                        return true;
                                    }
                                });
                                
                            });

                        });
                    });
                });
            }, 500);
        </script>
    }

}

@*通过load获取申请单内容*@
<div class="text-center text-danger" id="waiting"><i class="fa fa-3x fa-spinner fa-pulse"></i></div>
<div id="applyContent"></div>

@*审批信息*@
<div class="auditContent">
    <div class="panel panel-primary">
        <div class="panel-heading" id="auditHead">
            <i class='fa fa-pencil'></i> @bam.stepName
        </div>
        <div class="panel-body">
            @if (bam.isPass == null) {
                <form id="auditForm">
                    <input type="hidden" name="sysNo" value="@bam.sysNum" />
                    <input type="hidden" name="step" value="@bam.step" />
                    <input type="hidden" name="stepName" value="@bam.stepName" />
                    <input type="hidden" name="isPass" id="isPass" value="true" />
                    <input type="hidden" name="isSelfTakeOut" value="@(other.isSelfTakeOut?"true":"false")" />
                    
                    @if (bam.stepName.Contains("预约码")) {
                        <div class="b-div">
                            <span class="b-label">
                                带出人预约码:
                            </span>
                            <div class="b-input">
                                <div class="input-group">
                                    <input type="text" class="form-control" name="take_out_people_code" id="outCode" placeholder="外来人员需填写预约码" required value="@other.outerCode" />
                                    <input type="hidden" name="take_out_people_id" id="outerId" value="@other.outerId" />
                                    <input type="hidden" name="take_out_people_car" id="outerCar" value="@other.outerCar" />
                                    <input type="hidden" name="take_out_people_visit_no" id="outerVisitNo" value="@other.outerVisitNo" />
                                    <input type="hidden" name="items" id="items" value="[]" />
                                    <span class="input-group-btn">
                                        <button class="btn btn-primary" type="button" id="getCodeInfoBt" data-loading-text="查询中..."><span class="fa fa-search"></span> 获取信息</button>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="b-div">
                            <span class="b-label">
                                带出人姓名:
                            </span>
                            <span class="b-input">
                                <input type="text" class="form-control" name="take_out_people_name" id="outerName" placeholder="获取预约信息后带出" readonly value="@other.outerName" />
                            </span>
                        </div>
                        <div class="b-div">
                            <span class="b-label">
                                带出人电话:
                            </span>
                            <span class="b-input">
                                <input type="text" class="form-control" name="take_out_people_phone" id="outerPhone" placeholder="获取预约信息后带出" readonly value="@other.outerPhone" />
                            </span>
                        </div>

                        <div id="itemDiv"  style="margin:16px 0;">
                            <div class="b-div">
                                <span class="b-label">
                                    自带物品:
                                </span>
                                <div class="b-input">
                                    <button class="btn btn-primary btn-sm" type="button" id="editBt2" title="双击数据行也可修改" style="margin-top:6px;"> <i class="fa fa-edit"></i> 修改出厂数量 </button>
                                </div>
                            </div>
                            <table id="tb3"></table>
                            <div class="small text-danger"><i class="fa fa-info"></i> 自动带出外来人员在入厂预约时已备案的自带物品，只可修改出厂数量，且只能改少不能改多。</div>
                        </div>

                    }

                    @if (bam.stepName.Contains("上传") || bam.stepName.Contains("物流中心") || bam.stepName.Contains("老物流")) {
                        <div style="display:inline-block;">
                            <div id="picker"> <i class="fa fa-upload"></i> 上传物品图片 </div>
                        </div>
                        <div id="myUploader1">

                        </div>
                    }
                    @if (bam.stepName.Contains("物流中心") && !other.isSelfTakeOut) {
                        <div class="b-div">
                            <span class="b-label">
                                快递公司:
                            </span>
                            <span class="b-input">
                                <input type="text" class="form-control" name="ex_company" placeholder="填写快递公司" value="@other.exCompany" required />
                            </span>
                        </div>
                        <div class="b-div">
                            <span class="b-label">
                                快递单号:
                            </span>
                            <span class="b-input">
                                <input type="text" class="form-control" name="ex_no" placeholder="填写快递单号" value="@other.exNo" required />
                            </span>
                        </div>
                    }
                    @if (bam.stepName.Contains("返厂登记")) {
                        <div class="b-div">
                            <span class="b-label">
                                返厂时间:
                            </span>
                            <div class="b-input">
                                <div class="form-group" style="margin:0;">
                                    <div class="input-group date datePicker" id="datePicker2">
                                        <span class="input-group-addon"><i class="fa fa-calendar"></i> </span>
                                        <input class="form-control" type="text" name="back_time" autocomplete="off" required />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="b-div">
                            <span class="b-label">
                                物品状态:
                            </span>
                            <span class="b-input">
                                <select class="form-control" name="back_status" required>
                                    <option value="">---- 下拉选择物品状态 ----</option>
                                    <option value="正常">正常</option>
                                    <option value="损坏">损坏</option>
                                </select>
                            </span>
                        </div>
                    }
                    <textarea class="form-control" rows="2" name="opinion" id="opinion" placeholder="请在此处输入审核意见"></textarea>
                    
                </form>
                <div style="margin-top:12px;"></div>

                if (bam.stepName.Contains("返厂")) {
                    <button type="button" class="btn btn-block btn-success" onclick="audit(true)">@bam.stepName</button>
                }
                else if (bam.stepName.Contains("接收确认")) {
                    <button type="button" class="btn btn-block btn-success" onclick="audit(true)">实物确认已接收</button>
                }
                else {
                    <div class="btn-group btn-group-justified" role="group">                        
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-danger" onclick="audit(false)">拒绝</button>
                        </div>                        
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-success" onclick="audit(true)">同意</button>
                        </div>
                    </div>
                
                }
            }
            else {
                <div style="margin-top:12px;"></div>
                if (bam.isPass == true) {
                    <button type="button" class="btn btn-block btn-success disabled">已同意此申请</button>
                }
                else {
                    <button type="button" class="btn btn-block btn-danger disabled">已拒绝此申请</button>
                }
            }
        </div>
    </div>
</div>
@section Modal {
    @Html.Partial("_MessageDialog")
    @Html.Partial("_ConfirmDialog")
}