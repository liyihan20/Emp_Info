@using EmpInfo.Models;
@{
    BeginAuditModel bam = (BeginAuditModel)ViewData["bam"];
}
@section CSS{
    <link rel="stylesheet" href="@Url.Content("~/Content/webupload/webuploader.css")" />    
    }

@section Scripts {
    <script src="@Url.Content("~/Scripts/webuploader.min.js")"></script>
    <script src="@Url.Content("~/Scripts/myUploaderPro.js?v=2")"></script>
    <script>

        $(function () {
            $("#applyContent").load("CheckApply", { sysNo: "@bam.sysNum" }, function () {
                $($("#applyContent .panel-heading")[0]).html("<i class='fa fa-list'></i> @bam.billTypeName 详情");
                $("#waiting").remove();
                $(".auditContent").css("visibility", "visible");                
            });

            if ($("#myUploader1").length > 0) {
                console.log("1");
                $("#myUploader1").myUploader({
                    sysNum: "@bam.sysNum",
                    fileNumLimit: 5,
                    accept: {
                        title: '*',
                        extensions: '*',
                        mimeTypes: '*'
                    }
                });
            }

        })

        function audit(isPass) {
            if(isPass){
                if ("@bam.stepName".indexOf("上传") >= 0) {
                    if ($("#myUploader1").find(".list-group li").length < 1) {
                        toastr.error("请先上传放行物品图片");
                        return;
                    }
                }
            }else{
                if($.trim($("#opinion").val()) == ""){
                    toastr.error("拒绝时必须填写审批意见。")
                    return;
                }
            }

            openConfirmDialog("确认要" + (isPass ? "同意" : "拒绝") + "此申请吗？", function () {
                $("#isPass").val(isPass);

                $.ajax({
                    type: 'post',
                    url: 'HandleApply',
                    data: $("#auditForm").serialize(),
                    cache: false,
                    dataType: 'json',
                    success: function (data) {
                        if (data.suc) {
                            toastr.success(data.msg);
                            setTimeout(function () { window.location.href = "@string.Concat("GetMyAuditingList?billType=",bam.billType)"; }, 2000);
                        } else {
                            toastr.error(data.msg);
                        }

                    }
                });

            });
        }

    </script>
}

@*通过load获取申请单内容*@
<div class="text-center text-danger" id="waiting"><i class="fa fa-3x fa-spinner fa-pulse"></i></div>
<div id="applyContent"></div>

@*审批信息*@
<div class="auditContent">
    <div class="panel panel-primary">
        <div class="panel-heading" id="auditHead">
            <i class='fa fa-pencil'></i> 开始审批
        </div>
        <div class="panel-body">
            @if (bam.isPass == null) {
                <form id="auditForm">
                    <input type="hidden" name="sysNo" value="@bam.sysNum" />
                    <input type="hidden" name="step" value="@bam.step" />
                    <input type="hidden" name="stepName" value="@bam.stepName" />
                    <input type="hidden" name="isPass" id="isPass" value="true" />
                    
                    @if (bam.stepName.Contains("上传")) {
                        <div style="display:inline-block;">
                            <div id="picker"> <i class="fa fa-upload"></i> 上传物品图片 </div>
                        </div>
                        <div id="myUploader1">

                        </div>
                    }
                    <textarea class="form-control" rows="2" name="opinion" id="opinion" placeholder="请在此处输入审核意见"></textarea>
                    
                </form>
                <div style="margin-top:12px;"></div>
                <div class="btn-group btn-group-justified" role="group">                        
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-danger" onclick="audit(false)">拒绝</button>
                    </div>                        
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success" onclick="audit(true)">同意</button>
                    </div>
                </div>
            }
            else {
                <div style="margin-top:12px;"></div>
                if (bam.isPass == true) {
                    <button type="button" class="btn btn-block btn-success disabled">已同意此申请</button>
                }
                else {
                    <button type="button" class="btn btn-block btn-danger disabled">已拒绝此申请</button>
                }
            }
        </div>
    </div>
</div>
@section Modal {
    @Html.Partial("_MessageDialog")
    @Html.Partial("_ConfirmDialog")
}